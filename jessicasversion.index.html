<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†Šç†Šå­¸è‹±æ–‡ - èªéŸ³äº’å‹•ç·´ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        
        body {
            font-family: 'ZCOOL KuaiLe', sans-serif, system-ui;
            background-color: #f0f9ff;
            touch-action: manipulation;
        }
        
        .bounce {
            animation: bounce 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .mic-active {
            animation: pulse 1.5s infinite;
            background-color: #ef4444 !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-card" class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center border-8 border-yellow-300">
        <!-- åˆ†æ•¸é¡¯ç¤º -->
        <div class="flex justify-between items-center mb-6">
            <div id="starTray" class="text-2xl font-bold text-yellow-500">â­ æ”¶é›†ï¼š0</div>
            <div id="progress" class="text-gray-400 font-bold">1 / 5</div>
        </div>

        <!-- è§’è‰²èˆ‡é¡Œç›®å€ -->
        <div class="mb-6">
            <div id="avatar" class="text-7xl mb-4 transition-transform duration-300">ğŸ»</div>
            <div id="itemDisplay" class="text-6xl mb-4 bg-gray-50 rounded-2xl py-6">ğŸ</div>
            <h2 id="questText" class="text-2xl font-bold text-blue-600 mb-2">ç´…é€šé€šçš„æ°´æœæ˜¯ä»€éº¼ï¼Ÿ</h2>
            <div id="hintBox" class="text-lg text-gray-500 italic">èªªèªªçœ‹ï¼šapple</div>
        </div>

        <!-- äº’å‹•å›é¥‹ -->
        <div id="feedback" class="h-12 flex items-center justify-center text-lg font-medium text-purple-600 mb-8 bg-purple-50 rounded-full px-4">
            é»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹èªªè©±å§ï¼
        </div>

        <!-- æ§åˆ¶å€ -->
        <div class="flex flex-col gap-4">
            <button id="micBtn" onclick="handleMicClick()" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full py-4 px-8 text-xl font-bold flex items-center justify-center gap-3 transition-all transform active:scale-95 shadow-lg">
                <span id="micLabel">ğŸ¤ é»æˆ‘å¤§è²èªª</span>
            </button>
            <button id="nextBtn" onclick="goNext()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full py-2 px-6 font-bold transition-all">
                è·³é (NEXT)
            </button>
        </div>
    </div>

    <!-- å‹åˆ©è¦–çª— -->
    <div id="winModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-10 text-center max-w-sm w-full">
            <div class="text-8xl mb-4">ğŸ†</div>
            <h2 class="text-3xl font-bold text-blue-600 mb-2">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p id="finalScore" class="text-xl text-gray-600 mb-8">ä½ ä¸€å…±æ”¶é›†äº† 0 é¡†æ˜Ÿæ˜Ÿï¼</p>
            <button onclick="resetGame()" class="bg-green-500 hover:bg-green-600 text-white rounded-full w-full py-4 text-xl font-bold shadow-lg">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <script>
        /* ========= é¡Œåº« ========= */
        const quizData = [
            { word: "apple", icon: "ğŸ", question: "ç´…é€šé€šçš„æ°´æœæ˜¯ä»€éº¼ï¼Ÿ", character: "ğŸ‘©ğŸ»â€ğŸ«" },
            { word: "cat", icon: "ğŸ±", question: "èª°åœ¨å–µå–µå«å‘¢ï¼Ÿ", character: "ğŸ‘©ğŸ»â€ğŸ«" },
            { word: "dog", icon: "ğŸ¶", question: "å°ç‹—è¦æ€éº¼èªªï¼Ÿ", character: "ğŸ‘©ğŸ»â€ğŸ«" },
            { word: "ball", icon: "âš½", question: "æˆ‘å€‘ä¸€èµ·ä¾†è¸¢çƒï¼", character: "ğŸ‘©ğŸ»â€ğŸ«" },
            { word: ["fine", "good", "happy"], icon: "ğŸ˜Š", question: "How are you today?", character: "ğŸ‘©ğŸ»â€ğŸ«", isDialogue: true }
        ];

        let currentStep = 0;
        let stars = 0;
        let fails = 0;
        let recognition;

        const micBtn = document.getElementById('micBtn');
        const micLabel = document.getElementById('micLabel');
        const questText = document.getElementById('questText');
        const itemDisplay = document.getElementById('itemDisplay');
        const avatar = document.getElementById('avatar');
        const hintBox = document.getElementById('hintBox');
        const feedback = document.getElementById('feedback');
        const starTray = document.getElementById('starTray');
        const nextBtn = document.getElementById('nextBtn');
        const winModal = document.getElementById('winModal');
        const progressDisplay = document.getElementById('progress');

        /* ========= èªéŸ³è¾¨è­˜åˆå§‹åŒ– ========= */
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                micBtn.classList.add('mic-active');
                micLabel.innerText = 'ğŸ‘‚ æˆ‘åœ¨è½...';
            };

            recognition.onend = () => {
                micBtn.classList.remove('mic-active');
                micLabel.innerText = 'ğŸ¤ é»æˆ‘å¤§è²èªª';
            };

            recognition.onresult = (event) => {
                const said = event.results[0][0].transcript.toLowerCase();
                if (said.includes("next")) {
                    goNext(true);
                    return;
                }
                processResult(said);
            };

            recognition.onerror = (e) => {
                showFeedback("ç†Šç†Šæ²’è½æ¸…æ¥šï¼Œå†è©¦ä¸€æ¬¡å§ï¼", "ğŸ˜¯");
            };
        }

        /* ========= è¼‰å…¥é¡Œç›® ========= */
        function loadQuiz() {
            const data = quizData[currentStep];
            questText.innerText = data.question;
            itemDisplay.innerText = data.icon;
            avatar.innerText = data.character;
            progressDisplay.innerText = `${currentStep + 1} / ${quizData.length}`;
            
            hintBox.innerText = data.isDialogue
                ? "è©¦è‘—èªªï¼šI am fine"
                : `èªªèªªçœ‹ï¼š${data.word}`;
            
            feedback.innerText = "é»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹èªªè©±å§ï¼";
            fails = 0;
            nextBtn.style.opacity = '1';
            nextBtn.disabled = false;

            speak(data.question, 'zh-TW');
        }

        /* ========= éº¥å…‹é¢¨é»æ“Š ========= */
        function handleMicClick() {
            if (recognition) {
                try {
                    recognition.start();
                } catch(e) {
                    console.log("Recognition already started");
                }
            } else {
                alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½ï¼Œè«‹æ›´æ› Chrome ç€è¦½å™¨ã€‚");
            }
        }

        /* ========= åˆ¤æ–·çµæœ ========= */
        function processResult(said) {
            const data = quizData[currentStep];
            const targetWords = Array.isArray(data.word) ? data.word : [data.word];
            const correct = targetWords.some(w => said.includes(w));

            if (correct) {
                handleSuccess(said);
            } else {
                handleFailure(said);
            }
        }

        /* ========= æˆåŠŸè™•ç† ========= */
        function handleSuccess(said) {
            stars++;
            starTray.innerText = `â­ æ”¶é›†ï¼š${stars}`;
            showFeedback(`å¤ªæ£’äº†ï¼ä½ èªªäº†ã€Œ${said}ã€`, "ğŸ‰");
            speak("Great job!", "en-US");
            triggerConfetti();
            
            nextBtn.style.opacity = '0';
            nextBtn.disabled = true;

            setTimeout(() => {
                if (currentStep < quizData.length - 1) {
                    goNext();
                } else {
                    showWin();
                }
            }, 2500);
        }

        /* ========= å¤±æ•—è™•ç† ========= */
        function handleFailure(said) {
            fails++;
            showFeedback(`ä½ èªªäº†ã€Œ${said}ã€ï¼Œå†è©¦ä¸€æ¬¡ï¼`, "ğŸ¤”");
            speak("Try again", "en-US");

            if (fails >= 3) {
                const answer = quizData[currentStep].word;
                const hint = Array.isArray(answer) ? answer[0] : answer;
                showFeedback(`æç¤ºï¼šå¯ä»¥èªªã€Œ${hint}ã€æˆ–æŒ‰ NEXT`, "ğŸ’¡");
            }
        }

        /* ========= ä¸‹ä¸€é¡Œ ========= */
        function goNext(byVoice = false) {
            if (byVoice) speak("Next question!", "en-US");

            currentStep++;
            if (currentStep < quizData.length) {
                loadQuiz();
            } else {
                showWin();
            }
        }

        /* ========= èªéŸ³åˆæˆ ========= */
        function speak(text, lang) {
            if (!window.speechSynthesis) return;
            // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = lang;
            utter.rate = 1.0;
            window.speechSynthesis.speak(utter);
        }

        /* ========= è¦–è¦ºåé¥‹ ========= */
        function showFeedback(text, emoji) {
            feedback.innerText = `${emoji} ${text}`;
            avatar.classList.add('bounce');
            setTimeout(() => avatar.classList.remove('bounce'), 500);
        }

        /* ========= ç‰¹æ•ˆèˆ‡çµå°¾ ========= */
        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#3b82f6', '#fbbf24', '#a855f7']
            });
        }

        function showWin() {
            document.getElementById('finalScore').innerText = `ä½ ä¸€å…±æ”¶é›†äº† ${stars} é¡†æ˜Ÿæ˜Ÿï¼`;
            winModal.style.display = 'flex';
        }

        function resetGame() {
            currentStep = 0;
            stars = 0;
            starTray.innerText = `â­ æ”¶é›†ï¼š0`;
            winModal.style.display = 'none';
            loadQuiz();
        }

        // åˆå§‹åŒ–
        window.onload = loadQuiz;
    </script>
</body>
</html>
